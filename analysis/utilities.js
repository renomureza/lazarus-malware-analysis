const fs = require("fs/promises");
const zlib = require("node:zlib");

function decoder(input) {
  const reversed = input.split("").reverse().join("");
  const decoded = Buffer.from(reversed, "base64");
  return zlib.inflateSync(decoded).toString();
}

function getBytesLiteral(message) {
  const matchMessage = message.match(/.*b'(.*?)'/);
  return matchMessage[1];
}

async function decode(inputPath, outputPath) {
  let i = 1;

  let secretMsg = getBytesLiteral(await fs.readFile(inputPath, "utf-8"));

  while (true) {
    const result = decoder(secretMsg);
    console.log({ iteration: i, result });

    if (!result.startsWith("exec")) {
      await fs.writeFile(outputPath, result, "utf8");
      break;
    }

    secretMsg = getBytesLiteral(result);
    i++;
  }
}

module.exports = { decode };
